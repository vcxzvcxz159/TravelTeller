name: Deploy TravleTeller

on:
  push:
    branches:
      - master

jobs:
  deploy:
    # 1. ÎπåÎìúÎäî ÏÑ±Îä• Ï¢ãÏùÄ GitHub ÏÑúÎ≤Ñ(7GB RAM)ÏóêÏÑú ÏàòÌñâ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          # Ï∫êÏã±ÏùÑ Ï∂îÍ∞ÄÌïòÎ©¥ Îã§Ïùå ÎπåÎìúÎ∂ÄÌÑ∞ Ìõ®Ïî¨ Îπ®ÎùºÏßëÎãàÎã§
          cache: 'gradle'

      - name: Make Gradle Wrapper executable
        run: chmod +x ./gradlew
        
      # 2. Ïó¨Í∏∞ÏÑú ÎπåÎìúÌï©ÎãàÎã§. (ÎÇ¥ ÏÑúÎ≤Ñ Î¶¨ÏÜåÏä§Î•º Ïì∞ÏßÄ ÏïäÏùå)
      - name: Build Jar
        run: ./gradlew clean bootJar -x test

      # 3. ÎπåÎìúÎêú ÌååÏùºÎßå ÎÇ¥ ÏÑúÎ≤Ñ(158.179.173.122)Î°ú Ï†ÑÏÜ°
      - name: Copy Jar to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build/libs/TravleTeller-0.0.1-SNAPSHOT.jar"
          target: "/opt/travelteller/"
          # Ìè¥Îçî Íµ¨Ï°∞ Ïú†ÏßÄÎ•º ÏúÑÌï¥ strip_components ÏÇ¨Ïö© Í∂åÏû•
          strip_components: 2 

      # 4. ÎÇ¥ ÏÑúÎ≤ÑÏóê Ï†ëÏÜçÌï¥ÏÑú Ïã§ÌñâÎßå ÏãúÌÇ¥
      - name: Run application on server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/travelteller
            
            # 1. Í∏∞Ï°¥ Ïï± Ï¢ÖÎ£å (Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏù∏ ÌîÑÎ°úÏÑ∏Ïä§ Ï†ïÎ¶¨)
            echo "üõë Stopping existing application..."
            sudo pkill -f 'app.jar' || true
            sudo pkill -f 'TravleTeller' || true
            
            # 2. Ï†ÑÏÜ°Îêú ÌååÏùºÎ™ÖÏùÑ Í¥ÄÎ¶¨ÌïòÍ∏∞ Ìé∏ÌïòÍ≤å app.jarÎ°ú ÌÜµÌï©
            if [ -f TravleTeller*.jar ]; then
                mv TravleTeller*.jar app.jar
                echo "üì¶ File renamed to app.jar"
            fi
            
            # 3. Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Î∞±Í∑∏ÎùºÏö¥Îìú Ïã§Ìñâ
            # ÌôïÏù∏ÌïòÏã† ÏûêÎ∞î Ï†àÎåÄ Í≤ΩÎ°úÏôÄ oci ÌîÑÎ°úÌååÏùºÏùÑ Ï†ÅÏö©ÌñàÏäµÎãàÎã§.
            echo "üöÄ Starting application..."
            nohup /usr/lib/jvm/java-21-openjdk-amd64/bin/java \
              -Dspring.profiles.active=oci \
              -Xmx512m \
              -jar app.jar > app.log 2>&1 &
            
            # 4. Ïã§Ìñâ Ïó¨Î∂Ä Í≤ÄÏ¶ù (5Ï¥à ÎåÄÍ∏∞ ÌõÑ ÌîÑÎ°úÏÑ∏Ïä§ ÌôïÏù∏)
            sleep 5
            if ps -ef | grep -v grep | grep "app.jar" > /dev/null
            then
                echo "‚úÖ Deploy completed! Process is running."
                exit 0
            else
                echo "‚ùå Failed to start. Showing last 50 lines of app.log:"
                cat app.log | tail -n 50
                exit 1
            fi
