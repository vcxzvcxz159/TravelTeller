name: Deploy TravleTeller

on:
  push:
    branches:
      - master

jobs:
  deploy:
    # 1. ÎπåÎìúÎäî ÏÑ±Îä• Ï¢ãÏùÄ GitHub ÏÑúÎ≤Ñ(7GB RAM)ÏóêÏÑú ÏàòÌñâ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          # Ï∫êÏã±ÏùÑ Ï∂îÍ∞ÄÌïòÎ©¥ Îã§Ïùå ÎπåÎìúÎ∂ÄÌÑ∞ Ìõ®Ïî¨ Îπ®ÎùºÏßëÎãàÎã§
          cache: 'gradle'

      - name: Make Gradle Wrapper executable
        run: chmod +x ./gradlew
        
      # 2. Ïó¨Í∏∞ÏÑú ÎπåÎìúÌï©ÎãàÎã§. (ÎÇ¥ ÏÑúÎ≤Ñ Î¶¨ÏÜåÏä§Î•º Ïì∞ÏßÄ ÏïäÏùå)
      - name: Build Jar
        run: ./gradlew clean bootJar -x test

      # 3. ÎπåÎìúÎêú ÌååÏùºÎßå ÎÇ¥ ÏÑúÎ≤Ñ(158.179.173.122)Î°ú Ï†ÑÏÜ°
      - name: Copy Jar to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build/libs/TravleTeller-0.0.1-SNAPSHOT.jar"
          target: "/opt/travelteller/"
          # Ìè¥Îçî Íµ¨Ï°∞ Ïú†ÏßÄÎ•º ÏúÑÌï¥ strip_components ÏÇ¨Ïö© Í∂åÏû•
          strip_components: 2 

      # 4. ÎÇ¥ ÏÑúÎ≤ÑÏóê Ï†ëÏÜçÌï¥ÏÑú Ïã§ÌñâÎßå ÏãúÌÇ¥
      - name: Run application on server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/travelteller
            
            # 1. ÏÉàÎ°ú Ï†ÑÏÜ°Îêú ÌååÏùºÏù¥ ÏûàÎã§Î©¥ app.jarÎ°ú ÍµêÏ≤¥
            if [ -f TravleTeller*.jar ]; then
                mv TravleTeller*.jar app.jar
                echo "üì¶ New jar file applied."
            fi
            
            # 2. ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë (OSÍ∞Ä ÌîÑÎ°úÏÑ∏Ïä§Î•º Í¥ÄÎ¶¨ÌïòÎØÄÎ°ú 143 ÏóêÎü¨ Î∞©ÏßÄ)
            # Ïã§Ìñâ ÏãúÎßàÎã§ ÏÑúÎπÑÏä§ ÌååÏùº ÏÑ§Ï†ïÏóê ÏùòÌï¥ app.logÎäî Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.
            sudo systemctl restart travelteller
            
            # 3. ÏÉÅÌÉú ÌôïÏù∏
            sleep 3
            if sudo systemctl is-active travelteller > /dev/null
            then
                echo "‚úÖ Service is running perfectly!"
            else
                echo "‚ùå Service failed to start. Last logs:"
                tail -n 20 /opt/travelteller/app.log
                exit 1
            fi