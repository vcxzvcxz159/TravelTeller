name: Deploy TravleTeller

on:
  push:
    branches:
      - master

jobs:
  deploy:
    # 1. ë¹Œë“œëŠ” ì„±ëŠ¥ ì¢‹ì€ GitHub ì„œë²„(7GB RAM)ì—ì„œ ìˆ˜í–‰
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          # ìºì‹±ì„ ì¶”ê°€í•˜ë©´ ë‹¤ìŒ ë¹Œë“œë¶€í„° í›¨ì”¬ ë¹¨ë¼ì§‘ë‹ˆë‹¤
          cache: 'gradle'

      - name: Make Gradle Wrapper executable
        run: chmod +x ./gradlew
        
      # 2. ì—¬ê¸°ì„œ ë¹Œë“œí•©ë‹ˆë‹¤. (ë‚´ ì„œë²„ ë¦¬ì†ŒìŠ¤ë¥¼ ì“°ì§€ ì•ŠìŒ)
      - name: Build Jar
        run: ./gradlew clean bootJar -x test

      # 3. ë¹Œë“œëœ íŒŒì¼ë§Œ ë‚´ ì„œë²„(158.179.173.122)ë¡œ ì „ì†¡
      - name: Copy Jar to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build/libs/TravleTeller-0.0.1-SNAPSHOT.jar"
          target: "/opt/travelteller/"
          # í´ë” êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ strip_components ì‚¬ìš© ê¶Œì¥
          strip_components: 2 

      # 4. ë‚´ ì„œë²„ì— ì ‘ì†í•´ì„œ ì‹¤í–‰ë§Œ ì‹œí‚´
      - name: Run application on server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. ë””ë ‰í† ë¦¬ ì´ë™ ë° ê¶Œí•œ ì •ë¦¬
            cd /opt/travelteller
            
            # 2. ê¸°ì¡´ ì•± ì¢…ë£Œ
            sudo pkill -f 'app.jar' || true
            
            # 3. íŒŒì¼ëª… ë³€ê²½
            if [ -f TravleTeller*.jar ]; then
                mv TravleTeller*.jar app.jar
            fi
            
            # 4. ì‹¤í–‰ (í•µì‹¬: ê´„í˜¸ì™€ ì¶œë ¥ì„ ì™„ì „íˆ ì°¨ë‹¨í•˜ì—¬ SSH ì„¸ì…˜ì„ ì¦‰ì‹œ í•´ì œ)
            (nohup /usr/lib/jvm/java-21-openjdk-amd64/bin/java -Dspring.profiles.active=oci -Xmx512m -jar app.jar > app.log 2>&1 &)
            
            # 5. SSHê°€ ì¦‰ì‹œ ì„±ê³µìœ¼ë¡œ íŒë‹¨í•˜ê²Œ í•¨
            echo "ğŸš€ Deployment command sent."
