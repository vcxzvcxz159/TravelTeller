name: Deploy TravleTeller

on:
  push:
    branches:
      - master

jobs:
  deploy:
    # 1. ë¹Œë“œëŠ” ì„±ëŠ¥ ì¢‹ì€ GitHub ì„œë²„(7GB RAM)ì—ì„œ ìˆ˜í–‰
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          # ìºì‹±ì„ ì¶”ê°€í•˜ë©´ ë‹¤ìŒ ë¹Œë“œë¶€í„° í›¨ì”¬ ë¹¨ë¼ì§‘ë‹ˆë‹¤
          cache: 'gradle'

      - name: Make Gradle Wrapper executable
        run: chmod +x ./gradlew
        
      # 2. ì—¬ê¸°ì„œ ë¹Œë“œí•©ë‹ˆë‹¤. (ë‚´ ì„œë²„ ë¦¬ì†ŒìŠ¤ë¥¼ ì“°ì§€ ì•ŠìŒ)
      - name: Build Jar
        run: ./gradlew clean bootJar -x test

      # 3. ë¹Œë“œëœ íŒŒì¼ë§Œ ë‚´ ì„œë²„(158.179.173.122)ë¡œ ì „ì†¡
      - name: Copy Jar to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build/libs/TravleTeller-0.0.1-SNAPSHOT.jar"
          target: "/opt/travelteller/"
          # í´ë” êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ strip_components ì‚¬ìš© ê¶Œì¥
          strip_components: 2 

      # 4. ë‚´ ì„œë²„ì— ì ‘ì†í•´ì„œ ì‹¤í–‰ë§Œ ì‹œí‚´
      - name: Run application on server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/travelteller
            
            # 1. ìƒˆë¡œ ì „ì†¡ëœ íŒŒì¼ì´ ìˆë‹¤ë©´ app.jarë¡œ êµì²´
            if [ -f TravleTeller*.jar ]; then
                mv TravleTeller*.jar app.jar
                echo "ğŸ“¦ New jar file applied."
            fi
            
            # 2. ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (OSê°€ í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•˜ë¯€ë¡œ 143 ì—ëŸ¬ ë°©ì§€)
            sudo systemctl restart travelteller
            
            # 3. ìƒíƒœ í™•ì¸ (ì„±ê³µì ìœ¼ë¡œ ë–´ëŠ”ì§€ ì²´í¬)
            sleep 2
            sudo systemctl is-active travelteller
            echo "âœ… Service restarted successfully!!"
